{
  "version": "1.4",
  "description": "V1.4 完整自动化协议（含状态机）",

  "state_machine": {
    "file": "workflow_state.json",
    "doc": "STATE_MACHINE.md",
    "phases": ["idle", "planning", "quality_check", "resource_pull", "task_assign", "cursor_execute", "screenshot_review", "check_completion", "build_apk", "human_review", "completed"]
  },

  "architecture": {
    "claude_code": "策划 + 主程序 + 验收 + 状态机控制",
    "cursor": "Unity执行者",
    "n8n": "事件监听 + 状态记录 + 消息转发",
    "deepseek": "外部质检",
    "communication_channel": "Git + .task/"
  },

  "files": {
    "workflow_state.json": {
      "writer": "Claude / n8n",
      "reader": "Claude / n8n / Cursor",
      "purpose": "全局状态机，控制流程自动循环"
    },
    "current_task.json": {
      "writer": "Claude",
      "reader": "Cursor",
      "purpose": "任务分配"
    },
    "task_result.json": {
      "writer": "Cursor",
      "reader": "Claude",
      "purpose": "任务完成汇报"
    },
    "plan_draft.json": {
      "writer": "Claude",
      "reader": "NWF-07",
      "purpose": "策划案草稿，待质检"
    },
    "plan_review.json": {
      "writer": "NWF-07",
      "reader": "Claude",
      "purpose": "质检报告"
    },
    "ask_claude.json": {
      "writer": "Cursor",
      "reader": "n8n",
      "purpose": "Cursor提问"
    },
    "claude_response.json": {
      "writer": "n8n",
      "reader": "Cursor",
      "purpose": "回答Cursor问题"
    },
    "screenshots/": {
      "writer": "Cursor",
      "reader": "Claude",
      "purpose": "Unity运行截图"
    }
  },

  "git_commit_tags": {
    "[STATE]": "状态机状态变更",
    "[PLAN_READY]": "策划案写完，触发NWF-07质检",
    "[TASK_RESULT]": "Cursor任务完成，触发Claude验收",
    "[APK_READY]": "APK打包完成",
    "[NODE_COMPLETE]": "任务节点完成",
    "[PROGRESS]": "进度更新",
    "[ASK_CLAUDE]": "Cursor提问",
    "[FIX]": "修复提交",
    "[WORKFLOW_UPDATE]": "工作流变更"
  },

  "nwf_workflows": {
    "NWF-01": {"name": "Notion需求监听器", "trigger": "每5分钟", "status": "active"},
    "NWF-02": {"name": "Git事件分发器", "trigger": "GitHub Webhook", "status": "active"},
    "NWF-03": {"name": "状态记录器", "trigger": "NWF-02调用", "status": "active"},
    "NWF-05": {"name": "编译错误处理器", "trigger": "/webhook/build-error", "status": "active"},
    "NWF-06": {"name": "工作流同步器", "trigger": "[WORKFLOW_UPDATE]", "status": "pending"},
    "NWF-07": {"name": "策划质检器", "trigger": "[PLAN_READY]", "status": "pending"},
    "NWF-08": {"name": "状态机监听器", "trigger": "[STATE]", "status": "pending"}
  },

  "code_boundary": {
    "claude_writes": ["Scripts/Core/", "Scripts/Data/", "Resources/Configs/"],
    "cursor_writes": ["Scripts/Gameplay/", "Scripts/Combat/", "Scripts/UI/", "Scripts/Systems/", "Scripts/Editor/"]
  },

  "claude_startup_checklist": [
    "1. 读取 workflow_state.json 获取当前阶段",
    "2. 根据 current_phase 决定下一步动作",
    "3. 执行对应阶段的任务",
    "4. 完成后更新 workflow_state.json",
    "5. Git commit -m '[STATE] old → new'"
  ],

  "updated_at": "2026-02-06T04:20:00Z"
}
