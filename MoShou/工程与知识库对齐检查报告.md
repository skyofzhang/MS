# 工程与知识库对齐检查报告

**检查日期**: 2026-02-10  
**知识库版本**: 小游戏知识库 V3.0 / AI开发知识库 V4.3  
**工程路径**: `e:\AI_Project\MS\MoShou`

---

## 文档元数据（面向AI）

```json
{
  "document_audience": "AI",
  "document_purpose": "工程与知识库对齐检查；项目不合理项与可改进项清单；供后续AI执行修改时引用",
  "scope_note": "第二次核对：已再次阅读 Notion 知识库 L3/L2 与工程代码，新增 ISSUE-011～020、IMPROVE-011～019，均以证据路径/规则ID/WHEN-DO-VERIFY 表述",
  "format_rules": [
    "每条不合理项/可改进项有唯一ID（ISSUE-NNN / IMPROVE-NNN）",
    "引用时使用ID，避免自然语言歧义",
    "DO 字段为可执行动作或文件/符号路径",
    "VERIFY 字段为验证条件",
    "禁止主观形容词；用数值、路径、规则ID替代"
  ],
  "id_prefix": {
    "不合理": "ISSUE",
    "可改进": "IMPROVE"
  },
  "project_root": "e:\\AI_Project\\MS\\MoShou",
  "paths_relative_to": "project_root"
}
```

**引用方式**: 后续任务中可写「按 工程与知识库对齐检查报告.md 中 ISSUE-001 执行」或「实现 IMPROVE-003」。

---

## 一、总览

| 维度         | 知识库描述           | 工程实际           | 对齐状态   |
|--------------|----------------------|--------------------|------------|
| 项目名       | 我叫MT之魔兽归来(MS) | MoShou             | ✅ 一致    |
| 场景         | MainMenu, StageSelect, GameScene | 三者均存在 | ✅ 一致    |
| 核心玩法循环 | 出战→战斗→收获→结算→养成 | 已实现           | ✅ 一致    |
| 失败保留比例 | 经验×0.5, 金币×0.5 (GameConfig) | 代码中硬编码 /2 | ⚠️ 部分一致 |

---

## 二、脚本与模块对齐

### 2.1 知识库「当前工程实现状态」表 vs 实际脚本

知识库表中列出的部分类名与当前工程不一致，以下以**工程实际**为准。

| 模块    | 知识库列出的核心文件 | 工程实际存在 | 说明 |
|---------|----------------------|--------------|------|
| **Core** | GameManager, EventManager, ConfigManager, SaveSystem | GameManager, GameInitializer, MainMenuManager, StageSelectManager, LoadingManager, BattleStats, GameSceneSetup, MainMenuSceneSetup, StageSelectSceneSetup；SaveSystem 在 Systems 下 | ❌ 无 EventManager、ConfigManager；有多个 *Manager / *Setup |
| **Data** | ConfigDataClasses, SaveDataClasses, StatType, IStatsProvider | Equipment, ItemData, PlayerStats；SaveData 在 SaveSystem.cs 内 | ❌ 无独立 ConfigDataClasses、StatType、IStatsProvider；ItemData 内含 DropTable 等 |
| **Combat** | CombatSystem, BattleVfxManager, HitFlash | CombatSystem, ProjectileTrail；HitFlash 仅作 GameObject 命名用 (ProjectileMover.cs) | ❌ 无 BattleVfxManager；有 ProjectileTrail |
| **Gameplay** | PlayerController, MonsterController, CharacterVisualFactory | PlayerController, MonsterController, DropPickup, ProjectileMover, SimpleDropBehavior, TerrainGenerator | ❌ 无 CharacterVisualFactory；多出 Drop/Terrain 等 |
| **Systems** | MonsterSpawner, LootManager, EquipmentManager, InventoryService | MonsterSpawner, LootManager, EquipmentManager, InventoryManager, SaveSystem, AudioManager, RuntimeIconGenerator | ⚠️ 类名为 InventoryManager 非 InventoryService |
| **UI** | UIManager + 各 Panel | UIManager（无泛型 ShowPanel&lt;T&gt;，为 pausePanel/victoryPanel/defeatPanel 等 GameObject）+ 多 Screen/Panel/Component | ⚠️ API 与知识库描述不一致 |
| **Environment** | WangZheCanyonMapBuilder, TextureScroll | TerrainGenerator（Gameplay 下） | ❌ 无同名类；地形在 GameSceneSetup + TerrainGenerator |
| **Editor** | SetupWarcraftReturnProject, CC0 工具链 | SceneSetupTool, VisualSelfTest, BuildScript, UIArtApplier, VFXPrefabGenerator 等 | ✅ VisualSelfTest 存在；名称不同 |

**结论**: 知识库 L0 的「当前工程实现状态」表已过时，建议以本报告第二节为基准更新为当前工程结构（或改为「参考实现」并注明以实际代码为准）。

---

## 三、配置文件对齐

### 3.1 配置文件名与加载路径

| 知识库 (L3/L2) | 工程中加载路径 | 工程中存在的文件 | 对齐状态 |
|----------------|----------------|------------------|----------|
| GameConfig      | —              | **GameSettings.json** | ⚠️ 名称不同；未发现加载 "GameConfig" |
| SkillConfigs   | Configs/SkillConfigs (SkillUpgradePanel) | **无** SkillConfigs.json | ❌ 缺失；SkillUpgradePanel 有 CreateDefaultSkills() 兜底 |
| MonsterConfigs  | MonsterSpawner 使用代码内 MonsterStats，未直接读 JSON | **MonsterConfigs.json** 存在 | ⚠️ 工程用硬编码表，未用 JSON 驱动怪物属性 |
| EquipmentConfigs | Configs/EquipmentConfigs | **EquipmentConfigs.json** | ✅ 一致 |
| DropTableConfigs | Configs/DropTableConfigs (LootManager) | **LootConfigs.json**（结构也不同） | ❌ 文件名与结构均不一致；LootManager 走 CreateDefaultDropTables() |
| LevelConfigs    | —              | **StageConfigs.json** | ⚠️ 知识库称 LevelConfigs，工程为 StageConfigs |
| ShopConfigs    | Configs/ShopConfigs (ShopPanel) | **无** ShopConfigs.json | ❌ 缺失；可能导致商店配置加载为 null |
| ItemConfigs    | —              | **ItemConfigs.json** | ✅ 存在 |

### 3.2 失败保留比例 (PRD §4)

- **知识库**: 失败保留来自 `GameConfig.json` 的 `exp_retain_ratio` / `gold_retain_ratio`。
- **工程**: `GameManager.cs` 中 `partialGold = SessionGold / 2`、`partialExp = SessionExp / 2`（硬编码 0.5）。
- **建议**: 在 GameSettings（或单独 GameConfig）中增加上述两字段，GameManager 改为从配置读取，便于与知识库一致且可调。

---

## 四、资源路径对齐

### 4.1 知识库 RULE-RES 与工程实际

- **玩家**: 知识库 `Models/Player/Player_Archer`；工程 Prefab 在 **Prefabs/Characters/Player_Archer**，MonsterSpawner 优先用 Prefabs/Characters。工程以 Prefab 为主，与知识库「Models」描述不一致但实现合理。
- **怪物**: 知识库 §2 与工程 MonsterSpawner.MonsterPaths 一致（Prefabs/Characters + Models/Monsters 回退）。✅ 一致。
- **HUD/技能/结算/按钮/通用 UI**: GameSceneSetup、UIResourceBinder 等使用 `Sprites/UI/HUD/...`、`Sprites/UI/Skills/...` 等，与知识库 RULE-RES-005～010 命名一致。✅ 工程中 Sprites/UI 下存在对应子目录与文件。
- **VFX**: 知识库 Prefabs/VFX/...；工程 **Prefabs/VFX/** 下存在 VFX_Arrow_Trail、VFX_MultiShot、VFX_PierceShot 等。✅ 一致。
- **BGM/SFX**: 工程 **Audio/BGM/**、**Audio/SFX/** 与知识库 RULE-RES-012～015 命名一致。✅ 一致。

### 4.2 工程中存在但知识库未统一约定的路径

- **UI_Mockups/**：多处代码使用 `Resources.Load("UI_Mockups/Screens/UI_xxx")`、`"UI_Mockups/Components/UI_xxx"`，但 **Resources 下无 UI_Mockups 目录**，加载将得到 null。建议：在 Resources 下建立 UI_Mockups 并放入对应贴图，或将引用改为现有 Sprites/UI 路径（与 RULE-RES 一致）。
- **Configs 加载**: 见第三节，DropTableConfigs、SkillConfigs、ShopConfigs 需与文件名/结构对齐。

---

## 五、系统 API 对齐

### 5.1 知识库 §3 核心系统调用

| 规则 | 知识库描述 | 工程实际 | 对齐状态 |
|------|------------|----------|----------|
| RULE-SYS-001 | SaveSystem.Instance.CurrentPlayerStats；GetTotalMaxHp/GetTotalAttack；AddGold/AddExp | 存在且被多处使用 | ✅ 一致 |
| RULE-SYS-002 | CombatSystem.CalculateDamage / ApplyDamage | CombatSystem 为 static，提供 CalculateDamage(attack, defense)、DealDamage(attacker, target, baseDamage) | ⚠️ 无 ApplyDamage 方法名；逻辑为 DealDamage |
| RULE-SYS-003 | MonsterSpawner.Instance.SpawnWave(waveConfig) | 存在 StartWave(int wave)，内部按波次生成；未使用与知识库完全一致的 waveConfig 结构 | ⚠️ 行为一致，接口与知识库描述不完全一致 |
| RULE-SYS-004 | UIManager.Instance.ShowPanel&lt;PanelType&gt;/HidePanel/TogglePanel | UIManager 使用 ShowPausePanel、ShowVictoryPanel、ShowDefeatPanel 等，无泛型 Panel 类型 | ❌ API 不一致 |
| RULE-SYS-005 | 场景 MainMenu / StageSelect / GameScene | SceneManager.LoadScene 使用上述名称 | ✅ 一致 |

### 5.2 伤害公式 (知识库 §4)

- 知识库: baseDamage = attack * skillMultiplier，reduction = defense / (defense + 100)，finalDamage = baseDamage * (1 - reduction)，暴击再乘 (1+critDamage)，最小伤害 1。
- 工程: CombatSystem.CalculateDamage(attack, defense) 使用 reduction = defense/(defense+100)，attack*(1-reduction)；暴击在 DealDamage 中处理，CritDamage=1.5。✅ 与知识库一致。

---

## 六、怪物与技能数据对齐

### 6.1 怪物 ID（知识库 PRD §6 + L3 §4）

知识库规定: MON_SLIME_001, MON_GOBLIN_001, MON_WOLF_001, MON_GOBLIN_ELITE_001, BOSS_GOBLIN_KING。MonsterSpawner 仅使用上述 5 个 ID，与知识库一致。MonsterConfigs.json 除上述外还有 MON_SKELETON_001、MON_ORC_001 等，关卡配置（StageConfigs）中也有引用。若关卡/掉落等会按配置生成怪物，则 Spawner 当前硬编码 ID 与配置表会不一致。

### 6.2 技能

知识库: SK001 多重箭、SK002 穿透箭、SK003 战吼。工程: PlayerController 有技能 1/2；SkillUpgradePanel 有默认技能表；技能图标路径与 RULE-RES-006 一致。技能逻辑与知识库一致；SK003 战吼在工程中是否已实现需单独确认。

---

## 七、物理层与完成标准

- **Layer**: 知识库 Player=8, Enemy=9, Projectile=10, Environment=11。工程需在 Project Settings 中核对，未在本次自动检查。
- **完成标准 (RULE-DONE-001～004)**: 知识库要求 0 Error、PlayMode 可进、Visual Self Test 通过、核心循环可玩。
- **Editor**: **VisualSelfTest.cs** 存在，符合知识库「MoShou/Visual Self Test」菜单的预期。

---

## 八、差异汇总与建议

### 高优先级（影响运行或与知识库冲突）

1. **Configs/DropTableConfigs**：LootManager 加载 `Configs/DropTableConfigs`，工程仅有 LootConfigs.json 且结构不同，实际走 CreateDefaultDropTables()。建议：新增 `DropTableConfigs.json`，结构符合 `DropTableConfigTable`（含 `dropTables` 数组），或把 LootManager 改为加载 `Configs/LootConfigs` 并适配 LootConfigs 的 JSON 结构。
2. **Configs/ShopConfigs**：ShopPanel 加载 `Configs/ShopConfigs`，无该文件。建议：新增 ShopConfigs.json，或代码中增加 null 检查与默认商店数据，避免空引用。
3. **UI_Mockups 资源缺失**：多处 `Resources.Load("UI_Mockups/...")`，目录不存在。建议：在 Resources 下建立 UI_Mockups 并放置对应贴图，或将所有引用改为 Sprites/UI 下已有路径（与 RULE-RES 统一）。

### 中优先级（知识库一致性 / 可维护性）

4. **知识库「当前工程实现状态」表**：建议按本报告第二节更新为当前 Core/Data/Combat/Gameplay/Systems/UI/Editor 实际类名与文件，避免后续开发以错误类名为准。
5. **SkillConfigs.json**：SkillUpgradePanel 有默认技能兜底，但知识库与执行层期望有 SkillConfigs。建议：新增 `Configs/SkillConfigs.json`，结构与 SkillConfigTable 一致，便于策划改表。
6. **怪物属性数据源**：MonsterSpawner 使用代码内 MonsterStats 表，MonsterConfigs.json 未被 Spawner 使用。建议：要么改为从 MonsterConfigs.json 读取并驱动 Spawner（与知识库「单一数据源」一致），要么在知识库中注明「怪物战斗数值以代码 MonsterStats 为准」。
7. **失败保留比例配置化**：在 GameSettings 或 GameConfig 中增加 exp_retain_ratio、gold_retain_ratio，GameManager 读取后计算 partialGold/partialExp，与 PRD 一致。

### 低优先级（命名/文档）

8. **配置命名**: GameConfig vs GameSettings、LevelConfigs vs StageConfigs、InventoryService vs InventoryManager，在知识库或代码中二选一统一并注明映射关系。
9. **UIManager API**: 若需与知识库完全一致，可后续增加 ShowPanel&lt;T&gt;/HidePanel&lt;T&gt; 封装现有 GameObject 显隐。

---

## 十、项目工程目前不合理之处

以下条目供AI执行修改时按ID引用。每条包含：违反的规则（若有）、证据路径、严重程度、建议动作ID。

### ISSUE-001: 资源配置路径与实际目录不一致导致加载必为 null

| 字段 | 值 |
|------|-----|
| severity | high |
| violates | 知识库 FORBIDDEN-003；RULE-RES 约定路径应可达 |
| evidence_paths | CharacterInfoScreen.cs, StageSelectSceneSetup.cs, StageSelectScreen.cs, MainMenuSceneSetup.cs, MainMenuScreen.cs, InventoryPanel.cs, ResultScreen.cs, DefeatScreen.cs, SettingsPanel.cs, BottomNavigationBar.cs, TopStatusBar.cs 等 |
| evidence_pattern | Resources.Load&lt;Sprite&gt;("UI_Mockups/...") |
| fact | Assets/Resources/ 下无 UI_Mockups 目录；上述 Load 返回 null |
| suggested_action | IMPROVE-001 |

### ISSUE-002: 配置资源名与代码加载键不一致且无单一数据源

| 字段 | 值 |
|------|-----|
| severity | high |
| violates | RULE-KB-004；L3 配置文件名约定 |
| evidence_paths | LootManager.cs(83), ShopPanel.cs(89), SkillUpgradePanel.cs(72) |
| evidence_facts | LootManager 加载 Configs/DropTableConfigs，磁盘仅有 LootConfigs.json 且结构不同；ShopPanel 加载 Configs/ShopConfigs，无该文件；SkillUpgradePanel 加载 Configs/SkillConfigs，无该文件 |
| suggested_action | IMPROVE-002, IMPROVE-003 |

### ISSUE-003: 怪物数值存在双源且未声明权威源

| 字段 | 值 |
|------|-----|
| severity | medium |
| violates | RULE-KB-004 |
| evidence_paths | MonsterSpawner.cs(36-41 静态 MonsterStats), Configs/MonsterConfigs.json |
| suggested_action | IMPROVE-004 |

### ISSUE-004: 失败保留比例硬编码违反 PRD 可配置要求

| 字段 | 值 |
|------|-----|
| severity | low |
| evidence_paths | GameManager.cs(357-358) |
| evidence_snippet | partialGold = SessionGold / 2; partialExp = SessionExp / 2 |
| suggested_action | IMPROVE-005 |

### ISSUE-005: 场景与 UI 搭建逻辑集中在少数巨型脚本中

| 字段 | 值 |
|------|-----|
| severity | medium |
| evidence_paths | GameSceneSetup.cs(约2000+行), StageSelectSceneSetup.cs(约1000+行) |
| suggested_action | IMPROVE-006 |

### ISSUE-006: 多处重复的 Resources.Load 路径字符串无集中常量

| 字段 | 值 |
|------|-----|
| severity | low |
| suggested_action | IMPROVE-007 |

### ISSUE-007: UIManager 与知识库 RULE-SYS-004 接口不一致

| 字段 | 值 |
|------|-----|
| severity | low |
| violates | L3 RULE-SYS-004 |
| evidence_paths | UI/UIManager.cs |
| suggested_action | IMPROVE-008 |

### ISSUE-008: 存在运行时创建 Primitive 作为正式逻辑的降级路径

| 字段 | 值 |
|------|-----|
| severity | medium |
| violates | FORBIDDEN-001 |
| evidence_paths | LootManager.cs(50-68 EnsureDropPickupPrefab); ResourceLoader.CreateFallbackCube |
| suggested_action | IMPROVE-009 |

### ISSUE-009: 配置与代码字段命名不一致导致扩展时易错

| 字段 | 值 |
|------|-----|
| severity | low |
| suggested_action | IMPROVE-004 |

### ISSUE-010: 命名空间与全局类混用

| 字段 | 值 |
|------|-----|
| severity | low |
| violates | FORBIDDEN-004 |
| suggested_action | IMPROVE-010 |

### ISSUE-011: L3 §4 玩家基础属性与工程数值不一致且存在多源

| 字段 | 值 |
|------|-----|
| severity | medium |
| violates | RULE-KB-004 |
| evidence_paths | PlayerStats.cs(20-21), GameSettings.json |
| evidence_facts | 工程默认值 100/10/5；L3 为 150/15/10。GameSettings 含 playerSettings 但无代码在初始化时注入 PlayerStats |
| suggested_action | IMPROVE-011 |

### ISSUE-012: L3 §4 技能数据与工程多源不一致

| 字段 | 值 |
|------|-----|
| severity | medium |
| violates | RULE-KB-004 |
| evidence_paths | GameSettings.json(skillSettings); PlayerController/SkillUpgradePanel |
| suggested_action | IMPROVE-012 |

### ISSUE-013: RULE-RES-001 规定路径与工程实际加载方式不一致

| 字段 | 值 |
|------|-----|
| severity | low |
| fact | 知识库 Models/Player/Player_Archer；工程用 Prefabs/Characters/Player_Archer |
| suggested_action | IMPROVE-013 |

### ISSUE-014: RULE-RES-003 场景环境资源缺失

| 字段 | 值 |
|------|-----|
| severity | low |
| evidence_paths | Resources/Models/Environment/ 仅有 BossRoom；Forest 仅 .meta |
| suggested_action | IMPROVE-014 |

### ISSUE-015: RULE-SYS-002 与工程 Combat 接口不一致

| 字段 | 值 |
|------|-----|
| severity | medium |
| violates | L3 RULE-SYS-002 |
| evidence_paths | Combat/CombatSystem.cs |
| fact | 知识库 Instance/ApplyDamage/IStatsProvider；工程 static/DealDamage，无 IStatsProvider |
| suggested_action | IMPROVE-015 |

### ISSUE-016: ResourceLoader 降级使用 Color.magenta

| 字段 | 值 |
|------|-----|
| severity | low |
| evidence_paths | Utils/ResourceLoader.cs(128) CreateFallbackSprite |
| suggested_action | IMPROVE-016 |

### ISSUE-017: GameSettings.json 未被工程统一消费

| 字段 | 值 |
|------|-----|
| severity | medium |
| evidence_paths | Configs/GameSettings.json |
| suggested_action | IMPROVE-011, IMPROVE-012, IMPROVE-017 |

### ISSUE-018: 关卡波次未与 StageConfigs 驱动一致

| 字段 | 值 |
|------|-----|
| severity | medium |
| evidence_paths | MonsterSpawner.cs(GetMonsterIdForWave); StageConfigs.json(waves[].enemyIds) |
| suggested_action | IMPROVE-004 或工程内「波次由 StageConfigs 驱动」 |

### ISSUE-019: 部分 Resources.Load 后未做 null 检查

| 字段 | 值 |
|------|-----|
| severity | medium |
| violates | FORBIDDEN-003 |
| suggested_action | IMPROVE-018 |

### ISSUE-020: L3 §5 物理层与 Rigidbody 未在报告中验证

| 字段 | 值 |
|------|-----|
| severity | low |
| evidence_paths | GameSceneSetup.cs(373 layer=8; 578 layer=11) 仅部分 |
| suggested_action | IMPROVE-019 |

---

## 十一、可改进项

以下为可执行改进建议，格式为 WHEN-DO-VERIFY，供 AI 直接执行。部分条目含「方案B: 知识库中注明」等，供工程与知识库协同时参考。

### IMPROVE-001: 统一 UI 贴图加载路径与 Resources 结构

```yaml
WHEN: 需要修复 UI_Mockups 加载为 null 的问题
DO:
  - 方案A: 在 Assets/Resources 下创建 UI_Mockups/Screens 与 UI_Mockups/Components，将现有 Sprites/UI 中对应用途的贴图复制或移动至该路径，保证命名与代码中字符串一致
  - 方案B: 全局替换 Resources.Load 的 path，将 "UI_Mockups/Screens/XXX" 改为 "Sprites/UI/YYY"，建立 XXX->YYY 映射表
VERIFY: 各 Screen/Panel 在运行时不依赖 null sprite 即可显示；若方案B 则 grep "UI_Mockups" Assets/Scripts --include="*.cs" 输出为空
REF: ISSUE-001
```

### IMPROVE-002: 新增 DropTableConfigs.json 或改为使用 LootConfigs

```yaml
WHEN: 需要使 LootManager 与配置一致
DO:
  - 方案A: 在 Assets/Resources/Configs 下新增 DropTableConfigs.json，根结构为 {"dropTables": [ {...}, ... ]}，每项符合 MoShou.Data.DropTable
  - 方案B: 修改 LootManager.LoadDropTables()，加载 "Configs/LootConfigs"，并新增解析逻辑将 LootConfigs 的 lootTables 结构转换为 DropTable 字典；或 config==null 时仅走 CreateDefaultDropTables 并 Debug.LogWarning
VERIFY: LootManager 在 PlayMode 下加载配置成功或 config 为 null 时仅走默认表且有一条 Warning
REF: ISSUE-002
```

### IMPROVE-003: 新增 ShopConfigs.json 或代码内默认数据与 null 检查

```yaml
WHEN: 需要避免 ShopPanel 因缺少 ShopConfigs 导致空引用
DO:
  - 方案A: 在 Assets/Resources/Configs 下新增 ShopConfigs.json，结构与 ShopPanel 解析逻辑一致
  - 方案B: ShopPanel 加载 Configs/ShopConfigs 后若 configFile==null，使用内置默认商品列表并 Debug.LogWarning 一次
VERIFY: 打开商店界面不报错；商品列表可见
REF: ISSUE-002
```

### IMPROVE-004: 怪物数值单一数据源

```yaml
WHEN: 需要满足 RULE-KB-004
DO:
  - 方案A: MonsterSpawner 启动时从 Resources.Load<TextAsset>("Configs/MonsterConfigs") 读取 JSON，反序列化并转为 MonsterData 字典；删除或弃用 MonsterSpawner 内静态 MonsterStats 表
  - 方案B: 在知识库与本报告中明确写「怪物战斗数值以 MonsterSpawner 内静态 MonsterStats 为准」；MonsterConfigs.json 仅用于展示/图鉴
VERIFY: 方案A 时修改 MonsterConfigs.json 中某怪物 baseHp，运行后该怪物实际血量变化
REF: ISSUE-003, ISSUE-009
```

### IMPROVE-005: 失败保留比例配置化

```yaml
WHEN: 需要与 PRD 一致
DO: 在 GameSettings.json 或 GameConfig 中增加 exp_retain_ratio、gold_retain_ratio；GameManager 读取后计算 partialGold/partialExp
VERIFY: 修改 JSON 中比率为 0.3 后，失败时 partial 数值为 Session 的 30%
REF: ISSUE-004
```

### IMPROVE-006: 拆分巨型 SceneSetup 职责

```yaml
WHEN: 需要降低单文件复杂度
DO: 将 GameSceneSetup 拆为 TerrainSetup、HUDSetup、ResultUISetup、SkillUISetup、PauseUISetup 等；StageSelectSceneSetup 同理拆分
VERIFY: 场景加载后视觉与行为与拆分前一致；单文件行数显著减少
REF: ISSUE-005
```

### IMPROVE-007: 集中管理 Resources 路径常量

```yaml
WHEN: 需要统一资源路径
DO: 在 Utils 或 Constants/ResourcePaths.cs 中定义所有 Resources 相对路径常量；将 GameSceneSetup、各 Screen 等中的字面量 path 替换为上述常量
VERIFY: Resources.Load 的 path 来自常量或单处定义
REF: ISSUE-006
```

### IMPROVE-008: UIManager 提供与知识库一致的 Panel API

```yaml
WHEN: 需要满足 RULE-SYS-004
DO: 定义 enum PanelType；在 UIManager 中实现 ShowPanel(PanelType)、HidePanel(PanelType)、TogglePanel(PanelType)，内部映射到现有 GameObject
VERIFY: UIManager.Instance.ShowPanel(PanelType.Defeat) 与 ShowDefeatPanel() 行为一致
REF: ISSUE-007
```

### IMPROVE-009: LootManager 掉落物 Prefab 使用正式资源

```yaml
WHEN: 需要消除正式流程中的 CreatePrimitive 降级
DO: 在 Assets/Resources/Prefabs 下提供 DropPickup.prefab；LootManager 在 Awake 中若 dropPickupPrefab==null 则 Resources.Load("Prefabs/DropPickup")，仅仍为 null 时再走当前运行时创建并 Debug.LogWarning
VERIFY: 存在 Prefab 时 EnsureDropPickupPrefab 不执行 CreatePrimitive 分支
REF: ISSUE-008
```

### IMPROVE-010: 提供全局类与命名空间-类映射表（供 AI 引用）

```yaml
WHEN: 需要避免 FORBIDDEN-004 类引用错误
DO: 在本报告或知识库 L3 中新增「工程类引用表」：列出所有对外被引用的类，注明 namespace 或「全局」
VERIFY: 表中任一类名 + 命名空间与工程内实际声明一致
REF: ISSUE-010
```

### IMPROVE-011～019（摘要）

- **IMPROVE-011**: 玩家基础属性单一数据源（L3 §4 或 GameSettings 二选一并应用）。REF: ISSUE-011, ISSUE-017
- **IMPROVE-012**: 技能数值单一数据源（L3 表 / GameSettings / 代码选一）。REF: ISSUE-012, ISSUE-017
- **IMPROVE-013**: 工程内玩家加载路径统一（Prefabs/Characters 或 Models/Player）。REF: ISSUE-013
- **IMPROVE-014**: RULE-RES-003 场景资源补齐或工程内加载 null 时跳过并 Warning。REF: ISSUE-014
- **IMPROVE-015**: 工程内 Combat 实现 Instance、ApplyDamage、IStatsProvider。REF: ISSUE-015
- **IMPROVE-016**: 工程内降级颜色改为非 magenta，或工程内文档明确降级例外。REF: ISSUE-016
- **IMPROVE-017**: GameSettings 统一加载与注入到 PlayerStats/技能/战斗。REF: ISSUE-017
- **IMPROVE-018**: Resources.Load 后 null 检查审计与补齐。REF: ISSUE-019
- **IMPROVE-019**: VisualSelfTest 或 Editor 菜单增加 Layer/Physics 与 L3 §5 校验。REF: ISSUE-020

---

## 十二、检查方法说明

- 脚本与场景: 基于 `Assets/Scripts`、`Assets/Scenes` 目录列表与 grep 检索。
- 配置: 基于 `Assets/Resources/Configs` 下 json 与代码中 `Resources.Load<TextAsset>("Configs/xxx")`。
- 资源路径: 基于 `Resources` 下目录与代码中 `Resources.Load` 的 path 字符串。
- 系统 API: 基于对 SaveSystem、CombatSystem、MonsterSpawner、UIManager、SceneManager 的阅读。

---

## 十三、ID 索引（供 AI 快速定位）

| ID | 类型 | 描述 |
|----|------|------|
| ISSUE-001 | 不合理 | UI_Mockups 路径不存在，多处 Load 为 null |
| ISSUE-002 | 不合理 | 配置文件名/结构与代码不一致，无单一数据源 |
| ISSUE-003 | 不合理 | 怪物数值双源（代码表 vs MonsterConfigs.json） |
| ISSUE-004 | 不合理 | 失败保留比例硬编码 |
| ISSUE-005 | 不合理 | GameSceneSetup/StageSelectSceneSetup 单文件过大 |
| ISSUE-006 | 不合理 | 资源路径字符串分散无常量 |
| ISSUE-007 | 不合理 | UIManager 与 RULE-SYS-004 接口不一致 |
| ISSUE-008 | 不合理 | 正式流程中存在 CreatePrimitive 降级 |
| ISSUE-009 | 不合理 | 配置与代码字段命名不一致 |
| ISSUE-010 | 不合理 | 命名空间与全局类混用易导致引用错误 |
| ISSUE-011 | 不合理 | L3 §4 玩家基础属性与工程数值不一致；GameSettings 未注入 PlayerStats |
| ISSUE-012 | 不合理 | L3 §4 技能数据与 GameSettings/代码三源不一致 |
| ISSUE-013 | 不合理 | RULE-RES-001 规定 Models/Player，工程用 Prefabs/Characters |
| ISSUE-014 | 不合理 | RULE-RES-003 场景 Forest 环境资源缺失 |
| ISSUE-015 | 不合理 | RULE-SYS-002 要求 Instance/ApplyDamage/IStatsProvider，工程为 static/DealDamage/无接口 |
| ISSUE-016 | 不合理 | ResourceLoader 降级使用 Color.magenta，FORBIDDEN-001 例外未明确 |
| ISSUE-017 | 不合理 | GameSettings.json 未被统一加载并应用到 PlayerStats/技能等 |
| ISSUE-018 | 不合理 | 关卡波次未与 StageConfigs.waves 驱动一致 |
| ISSUE-019 | 不合理 | 部分 Resources.Load 后未做 null 检查（FORBIDDEN-003） |
| ISSUE-020 | 不合理 | L3 §5 物理层/Layer/Rigidbody 未在报告中验证 |
| IMPROVE-001～019 | 可改进 | 见十一节对应条目 |

---

**报告结束。** 建议优先处理 ISSUE-001、ISSUE-002、ISSUE-019 及对应 IMPROVE-001～003、IMPROVE-018；其次 ISSUE-011、ISSUE-012、ISSUE-017、ISSUE-015 与对应 IMPROVE。本报告面向 AI：引用时使用 ID，执行时按 WHEN-DO-VERIFY 或等效结构化步骤操作。
